#!/bin/bash

# Use this script to replace all strain level tax IDs and below with the parent species tax ID in seqid2taxid.map file - useful for custom taxanomic classifciation

nodes_segment=$1 # defined set of line numbers from nodes.dmp
nodes_all=$2 # nodes.dmp taxonomy file from ncbi ftp server
seqidmap=$3 # seqid2taxid.map file usually generated by kraken2
log=$4
ids=$5

count=0

while IFS= read -r line; do

    if [[ $(echo $line | awk '{print $5}') == "strain" || $(echo $line | awk '{print $5}') == "no rank"  ]]; then

        strain_id="$(echo $line | awk '{print $1}')"
        loop_again=true
        node=$line

        while $loop_again; do
            
            parent_id=$(echo $node | awk '{print $3}')
            parent_node=$(flock -s $nodes_all awk "\$1 == $parent_id" $nodes_all)

            if [[ $(echo $parent_node | awk '{print $5}') == "species" ]]; then

                loop_again=false
                species_id=$(echo $parent_node | awk '{print $1}')
                echo "$species_id|$strain_id" >> $ids
                #flock -x $seqidmap -c "sed -i \"s/\b$strain_id\b/$species_id/g\" $seqidmap" 2> $log

            elif [[ -n $parent_node ]]; then # make sure parent node is not null

                node=$parent_node
            
            else

                loop_again=false

            fi

        done


    fi


done < $nodes_segment